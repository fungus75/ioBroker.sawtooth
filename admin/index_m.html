<html>
<!-- these 4 files always have to be included -->
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>

<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>


<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jqGrid/ui.jqgrid-4.5.4.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jquery.multiselect-1.13.css"/>

<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/jquery.jqGrid-4.5.4.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/grid.locale-all.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>
<script type="text/javascript" src="words.js"></script>


<!-- you have to define 2 functions in the global scope: -->
<script type="text/javascript">
	// Dictionary (systemDictionary is global variable from adapter-settings.js)
  systemDictionary = {
    "Sawtooth Adapter Settings" : {"de" : "Einstellungen f√ºr den Sawtooth-Adapter" },
    "Technical Name"            : {"de" : "Technischer Name" },
    "Description"               : {"de" : "Beschreibung" }
  };

  // add new row
  function addRow(newIdx) {
        console.log("***** addRow");
        var template = $('#templateRow'); 
        var table    = $('#configTable');
        debugger;
        var clone    = template.clone();
        clone.find().each(function() {
            var oldId=$(this).attr("id");
            if (oldId) $(this).attr("id",+"_"+newIdx);
        });
        clone.attr("id","row_"+newIdx).css("display","");
      
        table.append(clone);
  }  
  
  function disalbeRow(element) {
        console.log("***** disalbeRow");
        $(element).closest("tr").attr("isVisible",0).css("display","none");
  }

  // the function loadSettings has to exist ...
  function load(settings, onChange) {
    console.log("***** load");

    if (!settings.numberOfLines) settings.numberOfLines = 0; 
    $('#configTable').attr('numOfLines', settings.numberOfLines);
    console.log(" --- numberOfLines = "+settings.numberOfLines);
    
    $(".addRow").click(function() {
        newIdx = parseInt($('#configTable').attr('numOfLines'))+1;
        addRow(newIdx);
        $('#configTable').attr('numOfLines', newIdx);
    });
    
	$('#username').val(settings.username).change(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
    
	$('#password').val(settings.password).change(function() {
		changed = true;
		$('#save').button("enable");  
	}).keyup(onChange);

        $('#locale').val(settings.locale).change(function() {
                changed = true;
                $('#save').button("enable");
        }).keyup(onChange);

    
	$('#vin').val(settings.vin).change(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);

	$('#ignoreApiError').prop('checked',settings.ignoreApiError).click(function() {
		//$('#ignoreApiError').prop('checked', !$('#ignoreApiError').prop('checked'));
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
	
	$('#useLocationApi').prop('checked',settings.useLocationApi).click(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
	
	$('#useHVACApi').prop('checked',settings.useHVACApi).click(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
	

	$('#kamereonApiKey').val(settings.kamereonApiKey).change(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
	
	$('#stopChargeWorkaroundHour').val(settings.stopChargeWorkaroundHour).change(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);

	$('#timeout').val(settings.timeout).change(function() {
		changed = true;
		$('#save').button("enable");
	}).keyup(onChange);
	

    onChange(false);
  }

  // ... and the function save has to exist.
  // you have to make sure the callback is called with the settings object as first param!
  function save(callback) {
    console.log("***** save");
    	var stopChargeWorkaroundHour=parseInt($('#stopChargeWorkaroundHour').val());
    	if (stopChargeWorkaroundHour<0 || stopChargeWorkaroundHour>23) stopChargeWorkaroundHour=0;
    	  
	  callback({
	    username : $('#username').val(),
	    password : $('#password').val(),
	    vin : $('#vin').val(),
            locale : $('#locale').val(),
	    ignoreApiError : $('#ignoreApiError').prop('checked'),
	    useLocationApi : $('#useLocationApi').prop('checked'),
	    useHVACApi : $('#useHVACApi').prop('checked'),
	    kamereonApiKey: $('#kamereonApiKey').val(),
	    stopChargeWorkaroundHour: stopChargeWorkaroundHour,
	    timeout: $('#timeout').val()
	  });
  }
</script>

<!-- you have to put your config page in a div with id adapter-container -->
<div id="adapter-container">

  <table>
    <tr>
      <td><img src="sawtooth.png" /></td>
      <td><h3 class="translate">Sawtooth Adapter Settings</h3></td>
    </tr>
  </table>

  <table style="padding-left: 24px" id="configTable" numOfLines="0">
    <tr>
      <th><label class="translate">Technical Name</label></th>
      <th><label class="translate">Description</label></th>
      <th><label class="addRow">(+)</label></th>
    </tr>
    <tr id="templateRow" isVisible="1" style="display:none">
      <td><input class="value" type="text" size="10"       id="techname"  /></td>
      <td><input class="value" type="text" size="40"       id="techname"  /></td>
      <td><label class=""      onclick="disalbeRow(this)"  id="delete" />(x)</td>
    </tr>


  </table>
  <br/><br/>
  <p class="translate">On save adapter restarts with new config immediately</p>
</div>

</html>
